<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>UnderSec | R-Series Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.7);
            --dim: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: #f8fafc;
            margin: 0;
            padding: 40px;
        }

        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        /* Top Row: Feed and Chart */
        .top-grid {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Bottom Row: Full Width Legend */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .feed-card {
            height: 400px;
            overflow-y: auto;
        }

        .chart-card {
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .val {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .lab {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            font-size: 10px;
            color: var(--dim);
            padding: 12px;
            border-bottom: 1px solid #334155;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
        }

        /* Horizontal Legend Grid */
        .legend-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .legend-item {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .legend-code {
            color: var(--primary);
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
        }

        .legend-desc {
            display: block;
            font-size: 11px;
            color: var(--dim);
            margin-top: 4px;
            line-height: 1.4;
        }

        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }

        .modal-content {
            background: #1e293b;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 400px;
            border: 1px solid var(--primary);
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>

<body>

    <div class="header-area">
        <h2 style="margin:0; letter-spacing: 2px;">UNDERSEC // <span style="color:var(--primary)">RISK_MONITOR</span>
        </h2>
        <div style="color:var(--dim); font-size: 12px; font-family: monospace;">NODE: 127.0.0.1:8000 // STATUS: <span
                style="color:#10b981">ACTIVE</span></div>
    </div>

    <div class="stat-grid">
        <div class="stat-card"><span class="lab">Total Alerts</span><span id="s1" class="val">0</span></div>
        <div class="stat-card"><span class="lab">Critical Rules</span><span id="s2" class="val" style="color:#f87171">R1
                - R3</span></div>
        <div class="stat-card"><span class="lab">Avg Risk Score</span><span id="s3" class="val">0</span></div>
        <div class="stat-card"><span class="lab">Active Employees</span><span id="s4" class="val">0</span></div>
    </div>

    <div class="top-grid">
        <div class="card feed-card">
            <h3 style="margin-top:0; font-size: 16px; border-bottom: 1px solid #334155; padding-bottom: 10px;">Live
                Threat Activity</h3>
            <table>
                <thead>
                    <tr>
                        <th>USER_ID</th>
                        <th>RULE_ID</th>
                        <th>RISK_SCORE</th>
                        <th>DETECTION_TIME</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="card chart-card">
            <h3 style="margin-top:0; font-size: 16px;">Rule Distribution</h3>
            <div style="width: 280px; height: 280px; margin-top: 10px;">
                <canvas id="riskChart"></canvas>
            </div>
            <p style="font-size: 10px; color: var(--dim); margin-top: 20px;">Click a slice to audit violations</p>
        </div>
    </div>

    <div class="bottom-grid">
        <div class="card" style="height: auto;">
            <h3 style="margin-top:0; font-size: 16px;">Rule Reference Legend</h3>
            <div class="legend-container">
                <div class="legend-item"><span class="legend-code">R1</span><span class="legend-desc">Confidential +
                        Public AI Paste</span></div>
                <div class="legend-item"><span class="legend-code">R2</span><span class="legend-desc">Confidential +
                        Cloud Upload</span></div>
                <div class="legend-item"><span class="legend-code">R3</span><span class="legend-desc">Confidential +
                        Risky Domain</span></div>
                <div class="legend-item"><span class="legend-code">R4</span><span class="legend-desc">Internal + Public
                        AI Paste</span></div>
                <div class="legend-item"><span class="legend-code">R5</span><span class="legend-desc">Internal + Cloud
                        Upload</span></div>
                <div class="legend-item"><span class="legend-code">R6</span><span class="legend-desc">Unknown
                        Destination Spike</span></div>
                <div class="legend-item"><span class="legend-code">R7</span><span class="legend-desc">Risky Destination
                        Visit</span></div>
                <div class="legend-item"><span class="legend-code">R8</span><span class="legend-desc">Off-Hours Activity
                        Burst</span></div>
                <div class="legend-item"><span class="legend-code">R9</span><span class="legend-desc">New Device
                        Context</span></div>
                <div class="legend-item"><span class="legend-code">R10</span><span class="legend-desc">New Geo
                        Context</span></div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="color:var(--primary); margin-top:0;"></h2>
            <p id="modalDesc" style="font-size: 13px; color: var(--dim);"></p>
            <div id="modalList" style="margin-top:20px;"></div>
            <button onclick="closeModal()"
                style="margin-top:25px; background:var(--primary); border:none; color:white; padding:10px 20px; border-radius:8px; cursor:pointer; width:100%;">Dismiss
                Audit</button>
        </div>
    </div>

    <script>
        const ruleDetails = {
            "R1": "Confidential data leaked to Public AI platforms.",
            "R2": "Confidential files detected on personal cloud storage.",
            "R3": "Confidential data interacting with unverified risky domains.",
            "R4": "Internal corporate data used in Public AI tools.",
            "R5": "Internal documents uploaded to external cloud accounts.",
            "R6": "Anomalous spike in traffic to unrecognized web destinations.",
            "R7": "Direct access to domains flagged as high-risk/malicious.",
            "R8": "Significant volume of data activity during non-working hours.",
            "R9": "Account access initiated from a new/unregistered hardware ID.",
            "R10": "Access detected from a new geographic coordinates."
        };

        let chart = null;
        let globalData = [];

        async function refresh() {
            try {
                const res = await fetch('http://127.0.0.1:8000/alerts?token=admin');
                const data = await res.json();
                globalData = data.alerts;

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                const rCounts = {};
                let totalScore = 0;
                let users = new Set();

                globalData.forEach(a => {
                    const rule = a.reasons[0];
                    rCounts[rule] = (rCounts[rule] || 0) + 1;
                    totalScore += a.risk_score;
                    users.add(a.user_id);

                    tbody.innerHTML += `<tr>
                        <td style="font-family:monospace; color:#e2e8f0;">${a.user_id}</td>
                        <td style="color:var(--primary); font-weight:bold;">${rule}</td>
                        <td style="font-weight:bold;">${a.risk_score}</td>
                        <td style="color:var(--dim)">${new Date(a.ts * 1000).toLocaleTimeString()}</td>
                    </tr>`;
                });

                document.getElementById('s1').innerText = globalData.length;
                document.getElementById('s3').innerText = globalData.length ? Math.round(totalScore / globalData.length) : 0;
                document.getElementById('s4').innerText = users.size;

                updateChart(rCounts);
            } catch (e) { console.error(e); }
        }

        function updateChart(counts) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#6366f1', '#818cf8', '#f43f5e', '#fbbf24', '#10b981', '#06b6d4', '#8b5cf6', '#ec4899', '#f97316', '#64748b'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    onClick: (evt, item) => {
                        if (item.length > 0) {
                            const index = item[0].index;
                            openModal(chart.data.labels[index]);
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function openModal(rule) {
            document.getElementById('modal').style.display = 'block';
            document.getElementById('modalTitle').innerText = `Violation Audit: ${rule}`;
            document.getElementById('modalDesc').innerText = ruleDetails[rule];
            const violators = globalData.filter(a => a.reasons[0] === rule);
            document.getElementById('modalList').innerHTML = violators.map(v => `
                <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #334155;">
                    <span style="font-family:monospace;">${v.user_id}</span>
                    <b style="color:${v.risk_score > 90 ? '#f87171' : '#fbbf24'}">Score: ${v.risk_score}</b>
                </div>`).join('');
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        refresh();
        setInterval(refresh, 5000);
    </script>
</body>

</html>